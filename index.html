<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Porjai Admin Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <link rel="stylesheet" href="style.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <link rel="apple-touch-icon" href="https://img2.pic.in.th/Porjai-Dashboard-logo.png">
    <link rel="icon" type="image/png" href="https://img2.pic.in.th/Porjai-Dashboard-logo.png">
</head>
<body>

    <div id="global-login-screen">
        <div class="login-box">
            <h2>üîí ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin</h2>
            <p style="color:#666; font-size:0.9rem;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Dashboard ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
            <input type="password" id="global-pass-input" class="login-input" placeholder="PIN Code">
            <button class="btn-login" onclick="checkGlobalLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            <p id="global-error-msg" style="color:red; display:none; margin-top:10px;">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
        </div>
    </div>

    <div id="main-menu">
        <div class="menu-title">Admin Portal</div>
        <div class="menu-grid">
            <div class="menu-card card-att" onclick="openApp('attendance')">
                <i class="fas fa-clock menu-icon"></i>
                <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</h2>
                <p class="desc">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô, ‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏™‡∏≤‡∏¢ ‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Ñ‡∏ô</p>
            </div>
            <div class="menu-card card-pos" onclick="openApp('pos')">
                <i class="fas fa-chart-line menu-icon"></i>
                <h2>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h2>
                <p class="desc">‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ ‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏î‡∏Æ‡∏¥‡∏ï</p>
            </div>
        </div>
    </div>

    <div id="attendance-view" class="app-view">
        <div class="app-navbar">
            <div class="nav-left" onclick="goHome()">
                <button class="nav-back-btn"><i class="fas fa-chevron-left"></i></button>
                <div class="nav-title">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</div>
            </div>
            <div style="font-size:0.9rem; opacity:0.8;">‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</div>
        </div>

        <div id="employee-modal" class="modal-overlay" onclick="closeEmployeeModal(event)">
            <div class="modal-content">
                <span class="close-modal" onclick="document.getElementById('employee-modal').style.display='none'">&times;</span>
                <h2 id="modal-title" style="margin-top:0; margin-bottom: 20px;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h2>
                <div class="modal-header-stat">
                    <div class="stat-box"><div class="stat-val text-green" id="modal-ontime">0</div><div class="stat-label">‡∏°‡∏≤‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</div></div>
                    <div class="stat-box"><div class="stat-val text-red" id="modal-late">0</div><div class="stat-label">‡∏°‡∏≤‡∏™‡∏≤‡∏¢ (‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</div></div>
                </div>
                <div style="font-size:1rem; font-weight:bold; color:#333; margin-bottom:10px;">
                    <i class="fas fa-history" style="color:#666;"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
                </div>
                <div id="modal-timeline-container" class="timeline-container"></div>
            </div>
        </div>

        <div class="container">
            <div class="tabs">
                <button class="tab-btn active" onclick="att_switchTab('daily')">üìÖ ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</button>
                <button class="tab-btn" onclick="att_switchTab('summary')">üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Ñ‡∏ô</button>
            </div>
            <div class="controls">
                <div class="date-nav-wrapper">
                    <button class="nav-btn" onclick="att_adjustDate(-1)">‚ùÆ</button>
                    <input type="date" id="att_dateFilter">
                    <button class="nav-btn" onclick="att_adjustDate(1)">‚ùØ</button>
                </div>
                <span id="att_thai-date-label" class="thai-date-label"></span>
                <div style="margin-top: 15px;">
                    <button onclick="att_fetchData()" style="cursor:pointer; background:none; border:none; color:#888; text-decoration:underline;">üîÑ ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
                    <span id="att_last-update" style="font-size:0.8em; color:#aaa; margin-left:10px;"></span>
                </div>
            </div>
            <div id="att_view-daily" class="view-section active">
                <div class="accordion-wrapper">
                    <div class="accordion-item">
                        <button class="accordion-header header-in active" onclick="toggleAccordion('list-in-content', this)">
                            <h3>üü¢ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô (<span id="att_count-in">0</span>)</h3><i class="fas fa-chevron-down"></i>
                        </button>
                        <div id="list-in-content" class="accordion-content" style="display:block;"><div id="att_list-in"></div></div>
                    </div>
                    <div class="accordion-item">
                        <button class="accordion-header header-out" onclick="toggleAccordion('list-out-content', this)">
                            <h3>üî¥ ‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô (<span id="att_count-out">0</span>)</h3><i class="fas fa-chevron-down"></i>
                        </button>
                        <div id="list-out-content" class="accordion-content"><div id="att_list-out"></div></div>
                    </div>
                </div>
            </div>
            <div id="att_view-summary" class="view-section">
                <div style="text-align:center; color:#666; margin-bottom:10px;">* ‡∏Å‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô (Timeline)</div>
                <div id="att_summary-container" class="summary-grid"></div>
            </div>
        </div>
    </div>


    <div id="pos-view" class="app-view">
        <div class="app-navbar">
            <div class="nav-left" onclick="goHome()">
                <button class="nav-back-btn"><i class="fas fa-chevron-left"></i></button>
                <div class="nav-title">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</div>
            </div>
            <div style="font-size:0.9rem; opacity:0.8;">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</div>
        </div>
        
        <div id="dashboardContainer">
            
            <div class="comparison-container">
                <div>
                    <div class="section-header">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ vs ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß</div>
                    <div class="stat-card">
                        <div style="font-size:0.9rem; color:#636e72;">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (<span id="pos_currMonthName">-</span>)</div>
                        <div style="font-size:1.8rem; font-weight:bold; margin:10px 0;" id="pos_currMonthVal">0 ‡∏ø</div>
                        <div style="font-size:0.8rem; color:#b2bec3;">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô: <span id="pos_prevMonthVal">0 ‡∏ø</span></div>
                        <div id="pos_trendText" style="margin-top:5px; font-weight:bold; color:#b2bec3;">--</div>
                        <div class="chart-box"><canvas id="pos_compChart"></canvas></div>
                    </div>
                </div>

                <div>
                    <div class="section-header">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏∞‡∏™‡∏°)</div>
                    <div class="stat-card">
                        <div class="gender-row">
                            <div class="gender-box g-male">
                                <i class="fas fa-male gender-icon"></i>
                                <div style="font-size:0.8rem;">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ä‡∏≤‡∏¢</div>
                                <div class="g-count" id="pos_maleCount">0</div>
                                <div class="g-top-service" id="pos_maleTop">-</div>
                            </div>
                            <div class="gender-box g-female">
                                <i class="fas fa-female gender-icon"></i>
                                <div style="font-size:0.8rem;">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏ç‡∏¥‡∏á</div>
                                <div class="g-count" id="pos_femaleCount">0</div>
                                <div class="g-top-service" id="pos_femaleTop">-</div>
                            </div>
                        </div>
                        <div style="margin-top:15px; font-size:0.75rem; color:#b2bec3; text-align:center;">* ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Gender ‡πÉ‡∏ô Google Sheet</div>
                    </div>
                </div>
            </div>
    
            <div style="clear:both;"></div>

            <div class="section-header">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</div>
            <div class="daily-wrapper">
                <div style="margin-bottom:20px;">
                    <input type="date" id="pos_dateFilter" style="padding:10px; border-radius:8px; border:1px solid #ddd; outline:none;">
                    <button onclick="pos_resetDaily()" style="padding:10px 15px; border-radius:8px; border:none; background:#eee; cursor:pointer;">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                </div>
                <div class="daily-summary-grid" id="pos_dailySummary" style="display:none;">
                    <div class="mini-box bg-1"><div>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</div><div style="font-size:1.4rem; font-weight:bold;" id="pos_dIncome">0</div></div>
                    <div class="mini-box bg-2"><div>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div><div style="font-size:1.4rem; font-weight:bold;" id="pos_dCust">0</div></div>
                    <div class="mini-box bg-3"><div>‡πÇ‡∏≠‡∏ô/‡∏™‡πÅ‡∏Å‡∏ô</div><div style="font-size:1.4rem; font-weight:bold;" id="pos_dScan">0</div></div>
                    <div class="mini-box bg-4"><div>‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</div><div style="font-size:1.4rem; font-weight:bold;" id="pos_dCash">0</div></div>
                </div>
                <div style="overflow-x:auto;">
                    <table id="pos_dataTable">
                        <thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th><th>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th></tr></thead>
                        <tbody id="pos_tableBody"></tbody>
                    </table>
                    <p id="pos_noDataMsg" style="text-align:center; color:#999; margin-top:20px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                </div>
            </div>
        </div>
    </div>


    <script>
        const GLOBAL_PIN = "8765"; 
        
        const loginScreen = document.getElementById('global-login-screen');
        const mainMenu = document.getElementById('main-menu');
        const passInput = document.getElementById('global-pass-input');

        passInput.addEventListener("keypress", (e)=>{ if(e.key==="Enter") checkGlobalLogin(); });

        function checkGlobalLogin() {
            if(passInput.value === GLOBAL_PIN) {
                loginScreen.style.opacity = '0';
                setTimeout(() => {
                    loginScreen.style.display = 'none';
                    mainMenu.style.display = 'flex';
                }, 300);
            } else {
                document.getElementById('global-error-msg').style.display = 'block';
            }
        }

        function openApp(appName) {
            mainMenu.style.display = 'none';
            if(appName === 'attendance') {
                document.getElementById('attendance-view').style.display = 'block';
                if(!att_isLoaded) att_init();
            } else if (appName === 'pos') {
                document.getElementById('pos-view').style.display = 'block';
                if(pos_parsedData.length === 0) {
                    pos_loadData();
                }
            }
        }

        function goHome() {
            document.querySelectorAll('.app-view').forEach(el => el.style.display = 'none');
            mainMenu.style.display = 'flex';
        }

        function toggleAccordion(contentId, btnElement) {
            const content = document.getElementById(contentId);
            if (content.style.display === "block") {
                content.style.display = "none";
                btnElement.classList.remove('active');
            } else {
                content.style.display = "block";
                btnElement.classList.add('active');
            }
        }
    </script>


    <script>
        const ATT_SHEET_ID = '14ZMzfHM4MHIHneUX9pMJa-P-HNoXGPk6sGM3y3mkvfw'; 
        const ATT_SHEET_NAME = 'data_base'; 
        const ATT_WORK_START_TIME = "09:00"; 
        const ATT_CSV_URL = `https://docs.google.com/spreadsheets/d/${ATT_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${ATT_SHEET_NAME}`;
        
        let att_allData = [];
        let att_isLoaded = false;

        function att_init() {
            att_setTodayDate();
            att_fetchData();
            att_isLoaded = true;
            document.getElementById('att_dateFilter').addEventListener('change', () => {
                att_updateDateLabel();
                att_renderDashboard();
            });
        }

        function att_setTodayDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            document.getElementById('att_dateFilter').value = `${year}-${month}-${day}`;
            att_updateDateLabel();
        }

        function att_adjustDate(days) {
            const dateInput = document.getElementById('att_dateFilter');
            if(!dateInput.value) return;
            const current = new Date(dateInput.value);
            current.setDate(current.getDate() + days);
            const year = current.getFullYear();
            const month = String(current.getMonth() + 1).padStart(2, '0');
            const day = String(current.getDate()).padStart(2, '0');
            dateInput.value = `${year}-${month}-${day}`;
            att_updateDateLabel();
            att_renderDashboard();
        }

        async function att_fetchData() {
            const updateLabel = document.getElementById('att_last-update');
            updateLabel.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";
            try {
                const response = await fetch(`${ATT_CSV_URL}&t=${Date.now()}`);
                const text = await response.text();
                if (text.trim().startsWith("<!DOCTYPE html>")) {
                    alert("‚ö†Ô∏è Error: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Publish to Web ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠ Sheet ‡∏ú‡∏¥‡∏î");
                    return;
                }
                att_allData = att_parseCSV(text);
                const now = new Date();
                updateLabel.innerText = `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ${now.toLocaleTimeString('th-TH')}`;
                att_renderDashboard();
                att_renderSummary();
            } catch (err) {
                console.error(err);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Attendance");
            }
        }

        function att_parseCSV(text) {
            const rows = text.split('\n').slice(1);
            return rows.map(row => {
                let cols = row.split(',').map(c => c.replace(/^"|"$/g, '').trim());
                if(cols.length < 3) return null;
                return { date: cols[0], time: cols[1], name: cols[2], shift: cols[3], action: cols[4], photoUrl: cols[5] };
            }).filter(item => item !== null);
        }

        function att_normalizeDate(dateStr) {
            if (!dateStr) return "";
            let d, m, y;
            if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                [y, m, d] = dateStr.split('-');
            } else if (dateStr.match(/^\d{1,2}[\/-]\d{1,2}[\/-]\d{4}$/)) {
                [d, m, y] = dateStr.split(/[\/-]/);
            } else { return dateStr; }
            y = parseInt(y);
            if (y < 2400) y += 543;
            return `${parseInt(d)}/${parseInt(m)}/${y}`;
        }

        function att_updateDateLabel() {
            const dateInput = document.getElementById('att_dateFilter').value;
            if(!dateInput) return;
            const [y, m, d] = dateInput.split('-');
            const thaiYear = parseInt(y) + 543;
            document.getElementById('att_thai-date-label').innerText = `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${d}/${m}/${thaiYear}`;
        }

        function att_renderDashboard() {
            const dateInput = document.getElementById('att_dateFilter').value;
            if(!dateInput) return;
            const [y, m, d] = dateInput.split('-');
            const searchDate = `${parseInt(d)}/${parseInt(m)}/${parseInt(y)+543}`; 

            const filtered = att_allData.filter(item => {
                if(!item.date) return false;
                return att_normalizeDate(item.date) === searchDate;
            });

            const listIn = document.getElementById('att_list-in');
            const listOut = document.getElementById('att_list-out');
            listIn.innerHTML = ''; listOut.innerHTML = '';
            
            let cIn = 0, cOut = 0;

            filtered.forEach(item => {
                const isCheckIn = item.action && item.action.includes('‡πÄ‡∏Ç‡πâ‡∏≤');
                const card = att_createCard(item, isCheckIn);
                if(isCheckIn) { listIn.appendChild(card); cIn++; }
                else { listOut.appendChild(card); cOut++; }
            });

            document.getElementById('att_count-in').innerText = cIn;
            document.getElementById('att_count-out').innerText = cOut;

            if(cIn===0) listIn.innerHTML = '<div style="text-align:center;color:#ccc; padding:20px;">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô -</div>';
            if(cOut===0) listOut.innerHTML = '<div style="text-align:center;color:#ccc; padding:20px;">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô -</div>';
        }

        function att_getShiftName(shiftTime) {
            if(!shiftTime) return "";
            const t = shiftTime.trim();
            if(t.startsWith("9:") || t.startsWith("09:")) return "‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤";
            if(t.startsWith("15:")) return "‡∏Å‡∏∞‡∏ö‡πà‡∏≤‡∏¢";
            return `‡∏Å‡∏∞ ${t}`;
        }

        function att_createCard(item, isCheckIn) {
            const div = document.createElement('div');
            let status = '', border = '';
            let shiftLabel = '';

            if(isCheckIn) {
                const shiftTime = (item.shift && item.shift.includes(':')) ? item.shift : ATT_WORK_START_TIME;
                const [h, m] = item.time.split(':').map(Number);
                const [lh, lm] = shiftTime.split(':').map(Number);
                const isLate = (h * 60 + m) > (lh * 60 + lm);
                
                status = isLate ? `<span class="badge late">‡∏™‡∏≤‡∏¢ (${item.time} ‡∏ô.)</span>` : `<span class="badge on-time">‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (${item.time} ‡∏ô.)</span>`;
                border = isLate ? 'border-late' : 'border-in';
                if(att_getShiftName(item.shift)) shiftLabel = `<span class="shift-badge">${att_getShiftName(item.shift)}</span>`;
            } else {
                status = `<span class="badge" style="background:#eee; color:#666;">‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô (${item.time} ‡∏ô.)</span>`;
                border = 'border-out';
            }

            let imgBtn = '';
            if(item.photoUrl && item.photoUrl.length > 5) {
                let url = item.photoUrl;
                const idMatch = url.match(/\/d\/([a-zA-Z0-9_-]+)/) || url.match(/id=([a-zA-Z0-9_-]+)/);
                if(idMatch) {
                    const fileId = idMatch[1];
                    url = `https://drive.google.com/uc?export=view&id=${fileId}`;
                    imgBtn = `<a href="${url}" target="_blank" class="img-link" title="‡∏î‡∏π‡∏£‡∏π‡∏õ">üì∑</a>`;
                }
            }

            div.className = `card ${border}`;
            div.innerHTML = `
                <div>
                    <div style="font-weight:bold; font-size:1.1rem;">${item.name}</div>
                    <div style="margin-top:5px;">${shiftLabel} ${status}</div>
                </div>
                ${imgBtn}
            `;
            return div;
        }

        function att_renderSummary() {
            const container = document.getElementById('att_summary-container');
            container.innerHTML = '';
            const stats = {};
            att_allData.forEach(d => {
                if(d.action && d.action.includes('‡πÄ‡∏Ç‡πâ‡∏≤')) {
                    const name = d.name;
                    if(!stats[name]) stats[name] = { total: 0, late: 0, onTime: 0 };
                    stats[name].total++;
                    const shiftTime = (d.shift && d.shift.includes(':')) ? d.shift : ATT_WORK_START_TIME;
                    const [h, m] = d.time.split(':').map(Number);
                    const [lh, lm] = shiftTime.split(':').map(Number);
                    if((h * 60 + m) > (lh * 60 + lm)) stats[name].late++;
                    else stats[name].onTime++;
                }
            });

            if(Object.keys(stats).length === 0) {
                container.innerHTML = '<div style="text-align:center; width:100%;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</div>';
                return;
            }

            for(const [name, s] of Object.entries(stats)) {
                const percentOnTime = Math.round((s.onTime / s.total) * 100);
                container.innerHTML += `
                    <div class="stat-card" onclick="openEmployeeDetail('${name}')">
                        <div class="stat-name">${name} <i class="fas fa-chevron-right" style="font-size:0.8em; color:#ccc;"></i></div>
                        <div class="stat-row"><span>üìÖ ‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:</span><strong>${s.total} ‡∏ß‡∏±‡∏ô</strong></div>
                        <div class="stat-row" style="color:#2e7d32;"><span>‚úÖ ‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤:</span><strong>${s.onTime} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</strong></div>
                        <div class="stat-row" style="color:#c62828;"><span>‚ùå ‡∏™‡∏≤‡∏¢:</span><strong>${s.late} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</strong></div>
                        <div class="progress-bar-bg"><div class="progress-bar-fill" style="width: ${percentOnTime}%"></div></div>
                        <div style="text-align:right; font-size:0.8em; color:#666; margin-top:5px;">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤: ${percentOnTime}%</div>
                    </div>
                `;
            }
        }

        function att_switchTab(tab) {
            document.querySelectorAll('#attendance-view .tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('#attendance-view .view-section').forEach(v => v.classList.remove('active'));
            document.getElementById('att_view-' + tab).classList.add('active');
            const controls = document.querySelector('#attendance-view .controls');
            if(tab === 'daily') controls.style.display = 'block';
            else controls.style.display = 'none';
        }

        // --- EMPLOYEE DETAIL MODAL LOGIC (TIMELINE VERSION) ---
        function openEmployeeDetail(name) {
            document.getElementById('modal-title').innerText = `${name}`;
            const timelineContainer = document.getElementById('modal-timeline-container');
            timelineContainer.innerHTML = '';

            // Filter data for this person
            const personData = att_allData.filter(d => d.name === name);
            
            // Helper to convert date for sorting
            const toDate = (dateStr, timeStr) => {
                const [d, m, y] = att_normalizeDate(dateStr).split('/');
                const [h, min] = timeStr.split(':');
                return new Date(y - 543, m - 1, d, h, min);
            };

            // Sort: Newest First
            personData.sort((a, b) => toDate(b.date, b.time) - toDate(a.date, a.time));

            let lateCount = 0;
            let onTimeCount = 0;

            if(personData.length === 0) {
                timelineContainer.innerHTML = '<div style="text-align:center; color:#ccc; margin-top:20px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>';
            }

            personData.forEach(item => {
                let dotClass = 'dot-gray';
                let cardClass = 'card-gray';
                let statusText = '‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô';
                let statusClass = 'text-gray';
                let icon = '<i class="fas fa-sign-out-alt"></i>';

                if(item.action && item.action.includes('‡πÄ‡∏Ç‡πâ‡∏≤')) {
                    const shiftTime = (item.shift && item.shift.includes(':')) ? item.shift : ATT_WORK_START_TIME;
                    const [h, m] = item.time.split(':').map(Number);
                    const [lh, lm] = shiftTime.split(':').map(Number);
                    const isLate = (h * 60 + m) > (lh * 60 + lm);
                    
                    if(isLate) {
                        dotClass = 'dot-red';
                        cardClass = 'card-red';
                        statusText = '‡∏™‡∏≤‡∏¢';
                        statusClass = 'text-red';
                        icon = '<i class="fas fa-exclamation-circle"></i>';
                        lateCount++;
                    } else {
                        dotClass = 'dot-green';
                        cardClass = 'card-green';
                        statusText = '‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤';
                        statusClass = 'text-green';
                        icon = '<i class="fas fa-check"></i>';
                        onTimeCount++;
                    }
                }

                const html = `
                    <div class="timeline-item">
                        <div class="timeline-dot ${dotClass}">${icon}</div>
                        <div class="timeline-date">${att_normalizeDate(item.date)}</div>
                        <div class="timeline-card ${cardClass}">
                            <div>
                                <div class="time-text">${item.time} ‡∏ô.</div>
                                <div style="font-size:0.8rem; color:#666;">${item.action}</div>
                            </div>
                            <div class="status-text ${statusClass}" style="font-weight:bold;">
                                ${statusText}
                            </div>
                        </div>
                    </div>
                `;
                timelineContainer.innerHTML += html;
            });

            // Update stats
            document.getElementById('modal-ontime').innerText = onTimeCount;
            document.getElementById('modal-late').innerText = lateCount;

            document.getElementById('employee-modal').style.display = 'flex';
        }

        function closeEmployeeModal(event) {
            if (event.target.classList.contains('modal-overlay')) {
                document.getElementById('employee-modal').style.display = 'none';
            }
        }
    </script>


    <script>
        const POS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSETBHr3lEIxRUO2bDaJcQ4kjVOdjaWVrTjSZ5FrsDX1GkWeqTBzONAIuOP__UXN8G1zxswxX6HZH10/pub?output=csv'; 
        
        let pos_myChart = null;
        let pos_parsedData = [];
        // Removed pos_status reference

        function pos_loadData() {
            Papa.parse(POS_CSV_URL, {
                download: true, header: true,
                complete: function(results) {
                    const raw = results.data.filter(r => r.Date && r.Amount);
                    if(raw.length === 0) {
                        console.error("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå");
                        return;
                    }

                    const today = new Date();
                    pos_parsedData = raw.map(row => {
                        let dObj = pos_parseDate(row.Date);
                        if (dObj && dObj > today) {
                             const parts = row.Date.split(' ')[0].split(/[\/-]/);
                             if(parts.length === 3) {
                                 dObj = pos_parseRawDate(parts[1], parts[0], parts[2]); 
                             }
                        }
                        return { ...row, dObj: dObj, amt: parseFloat(row.Amount)||0 };
                    }).filter(r => r.dObj);

                    console.log(`‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${pos_parsedData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`);
                    pos_calcComparison(); 
                    pos_initDateFilter(); 
                },
                error: function(err) { console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message); }
            });
        }

        function pos_parseDate(str) {
            if(!str) return null;
            const parts = str.split(' ')[0].split(/[\/-]/);
            if(parts.length < 3) return null;
            return pos_parseRawDate(parts[0], parts[1], parts[2]); 
        }

        function pos_parseRawDate(d, m, y) {
            let year = parseInt(y);
            if(year > 2400) year -= 543;
            if(year < 100) year += 2000;
            return new Date(year, parseInt(m)-1, parseInt(d));
        }

        function pos_calcComparison() {
            const now = new Date();
            const curM = now.getMonth();
            const curY = now.getFullYear();
            const prevD = new Date(curY, curM-1, 1);
            
            let cur=0, prev=0;
            // let sCounts = {}; // Old Logic

            // GENDER STATS
            let maleCount = 0;
            let femaleCount = 0;
            let mServices = {};
            let fServices = {};

            pos_parsedData.forEach(r => {
                // Monthly Income Logic
                if(r.dObj.getMonth()===curM && r.dObj.getFullYear()===curY) cur += r.amt;
                if(r.dObj.getMonth()===prevD.getMonth() && r.dObj.getFullYear()===prevD.getFullYear()) prev += r.amt;
                
                // Old Top Service Logic (Replaced by Gender)
                // const s = r.Service || "Other";
                // sCounts[s] = (sCounts[s]||0)+1;

                // --- NEW GENDER LOGIC ---
                // Try to find Gender Column. Check 'Gender' or '‡πÄ‡∏û‡∏®'
                let g = (r.Gender || r['‡πÄ‡∏û‡∏®'] || "").trim().toLowerCase();
                let s = r.Service || "Other";

                if (g === '‡∏ä‡∏≤‡∏¢' || g === 'male' || g === 'm') {
                    maleCount++;
                    mServices[s] = (mServices[s] || 0) + 1;
                } else if (g === '‡∏´‡∏ç‡∏¥‡∏á' || g === 'female' || g === 'f') {
                    femaleCount++;
                    fServices[s] = (fServices[s] || 0) + 1;
                }
            });

            // Find Top Service for Male
            let topMaleS = "-"; let maxM = 0;
            for(let [k, v] of Object.entries(mServices)) {
                if(v > maxM) { maxM = v; topMaleS = k; }
            }
            if(maxM > 0) topMaleS += ` (${maxM})`;

            // Find Top Service for Female
            let topFemaleS = "-"; let maxF = 0;
            for(let [k, v] of Object.entries(fServices)) {
                if(v > maxF) { maxF = v; topFemaleS = k; }
            }
            if(maxF > 0) topFemaleS += ` (${maxF})`;

            // UPDATE UI: GENDER
            document.getElementById('pos_maleCount').innerText = maleCount;
            document.getElementById('pos_maleTop').innerText = topMaleS;
            document.getElementById('pos_femaleCount').innerText = femaleCount;
            document.getElementById('pos_femaleTop').innerText = topFemaleS;

            // UPDATE UI: MONTHLY COMPARISON
            const thaiM = ["‡∏°.‡∏Ñ.","‡∏Å.‡∏û.","‡∏°‡∏µ.‡∏Ñ.","‡πÄ‡∏°.‡∏¢.","‡∏û.‡∏Ñ.","‡∏°‡∏¥.‡∏¢.","‡∏Å.‡∏Ñ.","‡∏™.‡∏Ñ.","‡∏Å.‡∏¢.","‡∏ï.‡∏Ñ.","‡∏û.‡∏¢.","‡∏ò.‡∏Ñ."];
            const curName = `${thaiM[curM]} ${curY+543}`;
            const prevName = `${thaiM[prevD.getMonth()]} ${prevD.getFullYear()+543}`;

            document.getElementById('pos_currMonthName').innerText = curName;
            document.getElementById('pos_currMonthVal').innerText = cur.toLocaleString() + " ‡∏ø";
            document.getElementById('pos_prevMonthVal').innerText = prev.toLocaleString() + " ‡∏ø";
            
            let pct = prev>0 ? ((cur-prev)/prev)*100 : (cur>0?100:0);
            const icon = cur>=prev ? "‚¨Ü" : "‚¨á";
            const color = cur>=prev ? "#00b894" : "#d63031";
            document.getElementById('pos_trendText').innerHTML = `<span style="color:${color}">${icon} ${Math.abs(pct).toFixed(1)}%</span>`;

            pos_renderChart(prev, cur, prevName, curName);
        }

        function pos_renderChart(prevVal, curVal, prevLabel, curLabel) {
            const ctx = document.getElementById('pos_compChart').getContext('2d');
            if(pos_myChart) pos_myChart.destroy(); 
            pos_myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [prevLabel, curLabel],
                    datasets: [{
                        label: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)',
                        data: [prevVal, curVal],
                        backgroundColor: ['rgba(200, 200, 200, 0.5)', 'rgba(108, 92, 231, 0.7)'],
                        borderColor: ['rgba(200, 200, 200, 1)', 'rgba(108, 92, 231, 1)'],
                        borderWidth: 1, borderRadius: 5
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } }
                }
            });
        }

        const pos_dateInput = document.getElementById('pos_dateFilter');
        function pos_initDateFilter() {
            const d = new Date();
            const offset = d.getTimezoneOffset() * 60000;
            pos_dateInput.value = (new Date(d - offset)).toISOString().slice(0, 10);
            pos_filterDaily();
            pos_dateInput.addEventListener('change', pos_filterDaily);
        }

        window.pos_resetDaily = function() {
            pos_dateInput.value = '';
            pos_renderTable(pos_parsedData);
            document.getElementById('pos_dailySummary').style.display = 'none';
        }

        function pos_filterDaily() {
            if(!pos_dateInput.value) return;
            const [y, m, d] = pos_dateInput.value.split('-').map(Number);
            
            const filtered = pos_parsedData.filter(r => 
                r.dObj.getDate()===d && r.dObj.getMonth()+1===m && r.dObj.getFullYear()===y
            );

            let sum=0, cScan=0, cCash=0;
            filtered.forEach(r => {
                sum += r.amt;
                const pm = (r['Payment Method']||"").toLowerCase();
                if(pm.includes('scan')||pm.includes('‡πÇ‡∏≠‡∏ô')) cScan++;
                else if(pm.includes('cash')||pm.includes('‡πÄ‡∏á‡∏¥‡∏ô')) cCash++;
            });

            document.getElementById('pos_dailySummary').style.display = 'grid';
            document.getElementById('pos_dIncome').innerText = sum.toLocaleString();
            document.getElementById('pos_dCust').innerText = filtered.length;
            document.getElementById('pos_dScan').innerText = cScan;
            document.getElementById('pos_dCash').innerText = cCash;
            pos_renderTable(filtered);
        }

        function pos_renderTable(data) {
            const tbody = document.getElementById('pos_tableBody');
            tbody.innerHTML = '';
            document.getElementById('pos_noDataMsg').style.display = data.length===0?'block':'none';
            
            [...data].reverse().forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${r.dObj.getDate()}/${r.dObj.getMonth()+1}/${r.dObj.getFullYear()+543}</td>
                                <td>${r.Service}</td>
                                <td>${r['Payment Method']}</td>
                                <td style="font-weight:bold;">${r.amt.toLocaleString()}</td>`;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>